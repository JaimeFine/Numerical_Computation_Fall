using LinearAlgebra
using Statistics

function estimate_rigid_transform(P::AbstractMatrix{<:Real}, Q::AbstractMatrix{<:Real})
    @assert size(P,1) == 3 && size(Q,1) == 3 && size(P,2) == size(Q,2)

    μP = mean(P, dims=2)
    μQ = mean(Q, dims=2)

    Pc = P .- μP
    Qc = Q .- μQ

    H = Pc * Qc'
    s = svd(H)
    U = s.U
    S = s.S
    V = s.V

    R = V * U'

    if det(R) < 0
        # flip the last column of V (handle general size with `end`)
        V[:, end] .= -V[:, end]
        R = V * U'
    end

    t = μQ .- R * μP
    return R, t
end

function rodrigues_from_R(R::AbstractMatrix{<:Real})
    θ = acos(clamp((tr(R) - 1)/2, -1, 1))
    if θ < 1e-12
        return zeros(3), 0.0
    end
    v = [R[3,2]-R[2,3], R[1,3]-R[3,1], R[2,1]-R[1,2]] / (2*sin(θ))
    r = v * θ
    return r, θ
end


# Initial 3d dots (homogeneous rows):
P_raw = [
    -25.7327472034808	-1.59577262045885	5.87232723842266	1
    -23.2634097372438	14.3253879566629	4.97988392890139	1
    -25.8452353838482	33.5453845417935	6.40512725569603	1
    -25.1510438713577	50.7200807373831	5.09386892787677	1
    -24.6402459457753	70.2671539145439	5.62965696410944	1
    -24.8524574244398	88.7824496505417	29.5957732469092	1
    -24.1151979423426	104.473093510165	28.5549053349860	1
    -24.8509396878059	125.061581242706	27.5604818542776	1
    -23.8814257112319	141.704617692516	27.2796331157763	1
    -23.9316946972275	158.261365009506	27.2533023470981	1
    -16.8630250295679	-1.33387549387625	15.7193831573943	1
    -16.6455342645390	15.2532445610935	13.5606857699719	1
    -15.2837224332178	34.8811704038875	13.9691554793906	1
    -14.0304036945461	51.0934241231331	13.8255671216803	1
    -15.0025185198656	70.9750341201626	15.0680994646156	1
    -16.8093863223279	87.1865285997239	23.8987546063096	1
    -16.3061657656827	104.233625899882	26.1052689501405	1
    -14.6201249002960	123.207042974534	25.8961641161296	1
    -14.7384963302307	141.964589291785	24.5822795425475	1
    -15.9221661156494	158.376557382677	24.4250310109189	1
    -6.35398821779790	-2.60735761673364	24.2363571203068	1
    -6.45943747619746	16.4652794056898	22.5915496179610	1
    -6.60885931806347	33.8024524688142	22.8615162116195	1
    -6.16600956008615	50.1998259441050	24.0271808453612	1
    -5.47296589451368	69.5541779208640	23.6170746629776	1
    -7.55282875026294	86.1508383526874	22.3700093639530	1
    -5.61168129217148	104.957666783252	20.4456202380541	1
    -6.87472510703604	124.574681235170	22.6253297458643	1
    -6.00428464532660	142.979419927659	22.9293536766321	1
    -7.66190152285782	160.054862347677	21.5424121550383	1
    1.19956207584737	-1.29568632340399	32.8916903868110	1
    3.31391028657589	14.2030866882719	32.1873723947121	1
    2.95320810610744	32.4338117313493	33.3156372104744	1
    2.15482928490362	52.3410943770241	33.3587470464684	1
    2.14446719584755	68.9550557482213	32.4204186665203	1
    3.75677961013725	87.4348004399097	18.1274908577944	1
    2.36255745884657	106.912846027560	17.4573568576505	1
    3.64720838779520	122.147626268474	17.8252946497119	1
    3.29808233708325	141.127411104558	18.6564192124632	1
    2.35906348627569	158.140487807884	18.5972435024115	1
    11.8047050450754	-2.04074764711590	41.5281618977467	1
    11.4798977667247	16.1273218357606	43.1634078042885	1
    10.1651735384686	32.3280858516372	42.4493483564183	1
    12.2922126737090	53.0078768247935	40.8759743742468	1
    11.0934315256078	70.0836902708467	41.6272745136525	1
    12.5903754744013	86.9419302529581	13.9004249717529	1
    12.0179515432823	104.684754942616	16.1055455946033	1
    12.2534719656988	123.346138949979	13.5006931955983	1
    10.4483911971031	140.920502904633	16.1172750568886	1
    11.8037534317354	159.073565358494	14.3528792233689	1
    20.3059474173526	-1.27772284645406	52.3753169349610	1
    20.5158773566175	15.9047454278101	51.7577917804672	1
    19.0717386440790	33.7577975059907	49.7396033921921	1
    20.2675941648055	51.4472027838760	49.6678839602677	1
    19.1952221273939	70.8268690071754	51.2024285918328	1
    20.1003894069921	87.1578385386222	10.6541209974794	1
    19.4488257958980	105.129406274911	11.2078982870057	1
    21.3520835388062	123.548217634878	11.5943940386213	1
    19.3937576547904	142.758174412665	12.2236722768863	1
    21.5054789140691	160.079463804626	13.1517509294894	1
    30.9393696156739	-3.23854095920606	60.5737121106266	1
    30.1847272694606	15.5165109458019	61.2494848848778	1
    28.5727546108657	32.4054313616665	58.7083712639873	1
    28.4588583699455	51.6464824739303	60.2319008154094	1
    29.1556476396393	68.9867893611492	58.7106663423596	1
    30.4457273359410	87.9812553744991	8.24501814210576	1
    28.7322573107857	106.487155257991	9.37191266168422	1
    30.5565719481959	123.489755266301	9.81209691952836	1
    30.5237320450669	140.334644619064	7.61279666301626	1
    30.4527126438061	159.327486144419	8.29893666191287	1
    39.8546086542448	-1.09398408246933	70.0958546003275	1
    38.7236007705220	16.7697750763507	69.2862972263711	1
    37.4980371312409	33.0109930099150	68.6893083180292	1
    38.6748954745927	50.2464304091533	68.0069335386326	1
    37.5003537469401	70.8973147878862	70.2332652528633	1
    39.1313670789415	88.9767366850326	6.59528036802561	1
    39.9623644202471	104.527259734057	6.47543641335937	1
    38.5913771477033	122.310259552170	4.53546271174718	1
    39.6855123399868	142.603304934748	3.60704626703925	1
    38.9206295384947	160.519547725262	4.33539226555259	1
    46.1923666952977	-3.19955504193867	77.2081610837887	1
    47.4511570745017	15.2786533879537	78.0438670240820	1
    48.6602953450372	33.2946725445122	77.7515436070515	1
    46.1445434320321	50.7014979476631	77.6175280422609	1
    46.0877754611117	70.1619327550759	76.9229066643172	1
    47.8327620408381	87.2902686123535	1.04684002444007	1
    47.9573791724377	105.037831265110	0.611016373487505	1
    47.6066946835379	122.582610727431	2.95031610706117	1
    47.9993710361443	142.642227475743	2.58798319116338	1
    48.4210413238596	160.008857330966	2.43128192359112	1
    57.0659906173533	-3.02615641658861	87.5949454835023	1
    57.6195818728295	14.1856190217294	87.5012023265455	1
    56.2982896435851	34.7458474748996	87.8905500542800	1
    57.9491086662309	51.7996010185676	88.5219095527857	1
    56.4064413417390	69.6906669890815	86.5373123628247	1
    56.9033850903113	88.9548763261051	-1.39795874564481	1
    56.4388427568652	106.457998249078	-2.72185884340712	1
    57.6423986285840	122.099620606540	-1.46541272340172	1
    57.0353909029624	141.796242940532	-1.56462405976441	1
    55.9615385324441	159.914739395375	-0.260541772882494	1
]

# Dots after the transformation (homogeneous rows):
Q_raw = [
    -34.3675782264961	8.56087762300337	3.01639796626039	1
    -36.5672852588963	23.0799475985791	9.70484567266506	1
    -44.4039012767356	40.1931331123634	14.5866221835492	1
    -47.6718828104939	56.2135012557450	20.0491848527205	1
    -53.0989208024341	73.6480973104290	27.0647512716112	1
    -76.4978062837133	80.6469014343330	44.9741018643329	1
    -79.5422128237941	95.2074500604731	50.1263125362738	1
    -84.8227921711599	114.347714586392	55.7103770704671	1
    -88.5678521050392	129.434943887597	61.7402637807551	1
    -93.0838287287126	144.451580550381	67.0539894484345	1
    -36.7057413807209	3.80079212609197	15.1646345026878	1
    -39.4498557485758	19.6875098842494	19.6280259901215	1
    -44.3006980501575	37.1542417866318	27.2869722278971	1
    -47.8657516762781	51.7639876011548	33.4735961870758	1
    -54.7951487371351	69.3750586832171	39.7665240943669	1
    -66.9907252166316	80.6497868533038	48.0252294270059	1
    -73.0129432159671	95.1371168362470	55.0662253205566	1
    -77.0247625177800	112.227880170645	62.4613675542985	1
    -81.2002458398742	129.772344275086	67.7851788419812	1
    -86.2448965256085	144.835432504189	72.0785889480871	1
    -36.6483043172090	-1.98598258374765	27.4573313733747	1
    -40.6501565354031	15.9778453831306	32.7268719468145	1
    -45.6623947174842	31.5912517493332	38.3635188861886	1
    -50.7514151814937	45.9221248817405	44.6210497741991	1
    -55.2989624728822	63.5489187604373	51.2433898616620	1
    -60.0926536215693	79.3230613747768	54.3299881188839	1
    -62.6037891866589	96.9363085763634	61.0109943131769	1
    -70.3455981117654	113.956317665202	67.4574937048210	1
    -75.0735154550512	130.411349429216	74.2738879662304	1
    -79.6423518959587	146.630229535851	77.7832605596146	1
    -39.1408406793338	-5.16360297774238	38.2916005545324	1
    -41.5778406707953	8.93473098711892	44.6537155734953	1
    -47.6107785777199	25.0298852868154	50.8433917713207	1
    -53.5322455519282	43.1356124441522	56.6793186482037	1
    -57.3464004376577	58.5726120964527	61.5839638145415	1
    -50.5517387409432	80.9827581746988	61.6628670184111	1
    -56.1647233115860	99.0564645926001	66.5231895827186	1
    -59.8344614672509	112.568039540741	72.6757987452338	1
    -65.8383816756044	129.462066837832	78.9678312689098	1
    -70.9771351272828	145.002872015775	83.7013948804132	1
    -39.2615309706247	-10.5310122204494	50.8927578747135	1
    -45.6420015425637	5.29615251554142	57.3463405524195	1
    -50.2827267701414	20.4099072500419	61.1857705331675	1
    -53.4612008323063	39.5561780834714	68.7996507314087	1
    -59.3866992181178	54.8508765653602	73.7540023754464	1
    -41.9975859643200	81.2974206293247	66.4452179813898	1
    -48.8417690390965	96.5334156784592	72.8498777684399	1
    -51.8003799789489	114.479860100664	77.7752947931761	1
    -59.6379274156092	129.529951230502	83.3458147680339	1
    -62.4379377576103	146.549605768168	89.4265283282483	1
    -42.7140785102944	-15.2056533276541	63.4124123078496	1
    -46.7972749019778	0.591123442840441	68.8393796729655	1
    -50.9717216866615	17.7492462795744	72.4536436726263	1
    -55.0273571906914	33.6741930253474	79.1093303382821	1
    -62.1013722519680	50.7220835957553	85.3064272353467	1
    -35.1622747644292	81.9981355083815	70.8918947863563	1
    -40.8589287186716	98.1252350557579	76.4751953550482	1
    -45.0449906334286	114.446216492282	84.1645926988235	1
    -51.9059670029383	131.807494635604	89.1411874443125	1
    -56.0825589570442	146.889858621756	96.9146126289084	1
    -42.1538998271308	-21.4985108917360	75.4213382505195	1
    -48.2173445348034	-4.70017255096278	81.2375735568468	1
    -51.8303833388265	11.8166382084594	84.1414089581391	1
    -58.2936505751571	28.6385079203403	91.0553831105915	1
    -61.4454190763478	44.8944892586315	96.4678999553985	1
    -27.4589992786233	82.5965090693525	78.2273773600412	1
    -34.3627082013580	99.0896405814471	83.4225306126492	1
    -38.2506611872380	114.114229572753	90.6166838179681	1
    -41.1815126229202	130.278494977383	94.9427595425747	1
    -46.9148435222475	147.213183893959	101.388617837503	1
    -44.7304617438054	-24.4250451737773	88.0525905515450	1
    -49.6429329043962	-7.78568879867273	92.5300786618280	1
    -54.3312162902406	7.30708756714216	96.5130000044681	1
    -57.8098710783740	23.0725046213483	102.698589646117	1
    -65.8164129574348	41.0004443954829	109.574590619752	1
    -21.3580418238012	83.2219981987274	84.6725334474857	1
    -25.0098419952562	97.2687476197391	90.3184941685697	1
    -29.1816373786919	114.323413912497	94.0080290331358	1
    -33.3540421737040	132.968673508681	100.994595616991	1
    -39.2352132878771	148.986678247137	106.557206500996	1
    -45.8351236153523	-29.9346542335303	96.0281431797467	1
    -50.7587859360081	-13.6729715043312	103.447197606221	1
    -54.7276494380815	2.63663251389069	110.108230098080	1
    -60.8454866867610	18.7374037135050	113.669377757406	1
    -65.6471514548059	36.6587345256189	119.582427878356	1
    -11.5515409944001	83.0100204372606	88.2962395615367	1
    -15.9770479061479	99.2538178151082	93.9296565636088	1
    -22.7387892845802	114.231244061735	100.515257963161	1
    -27.6915892581140	132.510358427459	107.149823086511	1
    -32.0507877199523	148.262381341534	113.038231745213	1
    -47.3793463866375	-35.2150020557043	110.024012475979	1
    -51.6665830825349	-19.6434625596982	115.999564670912	1
    -58.3372488060382	-1.03048589480350	121.802987568830	1
    -62.4867850592719	13.9812759183627	128.971159186328	1
    -66.7551792751094	31.1708920218607	132.535790874779	1
    -4.80099671804717	84.5246694605520	94.8658782640657	1
    -8.83136162378012	100.974624609585	99.5008456232060	1
    -13.3356201765793	114.500383963397	106.168157101952	1
    -18.9787292169392	132.452493096596	112.017287863393	1
    -25.5350074342148	148.452160617490	117.688227685617	1
]

# Convert the provided row-form homogeneous data to 3×n point matrices
# (columns are points) by taking the first 3 columns and transposing.
P = permutedims(P_raw[:, 1:3])  # 3×n
Q = permutedims(Q_raw[:, 1:3])  # 3×n

R, t = estimate_rigid_transform(P, Q)
r, θ = rodrigues_from_R(R)

# Expected answers:
# Rotation: a, b, c = 25.399051233106778 -54.101700051821325   5.637043873925570
# Panning: x, y, z = -15.174821832828904   9.590334711153755  21.176335086376653

println("Ángulo (rad): ", θ)
println("Ángulo (deg): ", θ*180/pi)
println("Vector de Rodrigues r: ", r)
println("Traslación t: ", vec(t))
println("Matriz de rotación R:\n", R)
